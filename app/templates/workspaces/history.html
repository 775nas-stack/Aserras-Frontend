{% extends "base.html" %}
{% block content %}
<div class="p-6 rounded-3xl border border-slate-200 dark:border-slate-800 bg-[var(--surface-strong)] shadow-sm">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h2 class="text-lg font-semibold">Personal history</h2>
            <p class="text-sm text-[var(--text-muted)]">All of your generations synced from Aserras Brain.</p>
        </div>
        <button id="refreshHistory" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-sm">
            Refresh
            <span id="historyLoading" class="hidden w-4 h-4 border-2 border-blue-200 rounded-full spinner"></span>
        </button>
    </div>
    {% if warning %}
    <div class="mb-4 px-4 py-3 rounded-xl border border-amber-200 text-amber-600 bg-amber-50 dark:bg-amber-500/10">{{ warning }}</div>
    {% endif %}
    <div id="historyList" class="space-y-4">
        {% if history %}
            {% for item in history %}
            <article class="p-4 rounded-2xl border border-slate-200 dark:border-slate-800">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <div>
                        <p class="text-sm font-medium text-[var(--text)]">{{ item.get('title', 'Untitled entry') }}</p>
                        <p class="text-xs text-[var(--text-muted)]">{{ item.get('type', 'chat') | capitalize }} • {{ item.get('created_at') or item.get('createdAt') }}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <a href="/{{ item.get('type', 'chat') }}?prompt={{ item.get('prompt', '')|urlencode }}" class="text-xs px-3 py-1.5 rounded-lg bg-blue-500/10 text-blue-500">Re-run</a>
                        <button type="button" data-prompt="{{ item.get('prompt', '') }}" class="text-xs px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700">Copy prompt</button>
                    </div>
                </div>
                {% if item.get('preview_url') or item.get('previewUrl') %}
                <div class="mt-3">
                    <img src="{{ item.get('preview_url') or item.get('previewUrl') }}" alt="History preview" class="rounded-xl border border-slate-200 dark:border-slate-800 max-h-64 object-cover">
                </div>
                {% endif %}
                <p class="mt-3 text-sm text-[var(--text-muted)] whitespace-pre-wrap">{{ item.get('prompt', 'No prompt available') }}</p>
            </article>
            {% endfor %}
        {% else %}
            <p class="text-sm text-[var(--text-muted)]">No history yet. Your generations will appear here once you start creating.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
    const refreshHistory = document.getElementById('refreshHistory');
    const historyList = document.getElementById('historyList');
    const historyLoading = document.getElementById('historyLoading');

    refreshHistory?.addEventListener('click', async () => {
        historyLoading?.classList.remove('hidden');
        try {
            const response = await fetch('/api/history');
            if (!response.ok) {
                const detail = await response.json();
                throw new Error(detail.detail || 'Unable to load history');
            }
            const data = await response.json();
            renderHistory(data.items || []);
        } catch (error) {
            renderError(error.message);
        } finally {
            historyLoading?.classList.add('hidden');
        }
    });

    function renderHistory(items) {
        if (!historyList) return;
        if (!items.length) {
            historyList.innerHTML = '<p class="text-sm text-[var(--text-muted)]">No history entries found.</p>';
            return;
        }
        historyList.innerHTML = '';
        items.forEach((item) => {
            const element = document.createElement('article');
            element.className = 'p-4 rounded-2xl border border-slate-200 dark:border-slate-800';
            element.innerHTML = `
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <div>
                        <p class="text-sm font-medium text-[var(--text)]">${escapeHtml(item.title || 'Untitled entry')}</p>
                        <p class="text-xs text-[var(--text-muted)]">${escapeHtml((item.type || 'chat').toUpperCase())} • ${escapeHtml(item.created_at || item.createdAt || '')}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <a href="/${item.type || 'chat'}?prompt=${encodeURIComponent(item.prompt || '')}" class="text-xs px-3 py-1.5 rounded-lg bg-blue-500/10 text-blue-500">Re-run</a>
                        <button type="button" data-prompt="${escapeHtml(item.prompt || '')}" class="text-xs px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700">Copy prompt</button>
                    </div>
                </div>
                ${item.preview_url || item.previewUrl ? `<div class="mt-3"><img src="${item.preview_url || item.previewUrl}" alt="History preview" class="rounded-xl border border-slate-200 dark:border-slate-800 max-h-64 object-cover"></div>` : ''}
                <p class="mt-3 text-sm text-[var(--text-muted)] whitespace-pre-wrap">${escapeHtml(item.prompt || 'No prompt available')}</p>
            `;
            historyList.appendChild(element);
        });
        attachCopyHandlers();
    }

    function renderError(message) {
        if (!historyList) return;
        historyList.innerHTML = `<div class="px-4 py-3 rounded-2xl border border-red-200 text-red-600 bg-red-50 dark:bg-red-500/10">${message}</div>`;
    }

    function attachCopyHandlers() {
        historyList.querySelectorAll('[data-prompt]').forEach((button) => {
            button.addEventListener('click', () => {
                navigator.clipboard.writeText(button.dataset.prompt || '').then(() => {
                    const toast = document.getElementById('toast');
                    if (!toast) return;
                    toast.textContent = 'Prompt copied to clipboard.';
                    toast.classList.remove('hidden');
                    setTimeout(() => toast.classList.add('hidden'), 2000);
                });
            });
        });
    }

    attachCopyHandlers();

    function escapeHtml(value) {
        return value.replace(/[&<>"']/g, (char) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[char] || char));
    }
</script>
{% endblock %}
